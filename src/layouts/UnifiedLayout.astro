---
import '../styles/tailwind.css'
import '../assets/scss/index.scss'
import SiteMeta from '../components/SiteMeta.astro'
import LocalizedMeta from '../components/LocalizedMeta.astro'
import Header from '../components/Header.astro'
import Breadcrumbs from '../components/Breadcrumbs.astro'
import Footer from '../components/Footer.astro'
import CookieBanner from '../components/CookieBanner.astro'
import SEODebug from '../components/SEODebug.astro'
import { getLocaleFromUrl } from '../utils/i18n'
import { getAlternateUrls } from '../utils/i18n'
import { ClientRouter } from 'astro:transitions'

interface Props {
  title?: string
  description?: string
  url?: string
  image?: string
  author?: string
  jsonLd?: any
  pageKey?: string
  useLocalizedMeta?: boolean
  enableTransitions?: boolean
}

const {
  title = 'Stefano Chermaz — Consulenza IT (M365, AI, DORA/GDPR)',
  description = 'Progetti affidabili e scalabili su Microsoft 365 e AI. Modern Workplace, automazioni, chatbot e governance.',
  url = Astro.site,
  image = '/images/og-default.svg',
  author = 'Stefano Chermaz',
  jsonLd = {
    '@context': 'https://schema.org',
    '@type': 'Organization',
    name: 'Stefano Chermaz — Consulenza IT',
    url: Astro.site,
    sameAs: ['https://www.linkedin.com/in/stefanochermaz/'],
  },
  pageKey,
  useLocalizedMeta = false,
  enableTransitions = false
} = Astro.props as Props

const locale = getLocaleFromUrl(Astro.url)
---

<html lang={locale} dir="ltr" class="theme-loading">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <script is:inline>
      // Inizializza il tema PRIMA dei CSS per evitare FOUC
      (function() {
        try {
          var ls = localStorage.getItem('theme') || localStorage.getItem('aac-theme') || ''
          var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
          var isDark = ls ? ls === 'dark' : prefersDark
          var html = document.documentElement
          
          // Rimuovi sempre tutte le classi di tema prima di aggiungere quella corretta
          html.classList.remove('dark', 'darkmode', 'theme-loading')
          
          if (isDark) {
            html.classList.add('dark')
            html.classList.add('darkmode')
            // Forza il tema scuro tramite CSS custom properties
            html.style.colorScheme = 'dark'
          } else {
            html.style.colorScheme = 'light'
          }
          
          // Marca come inizializzato
          html.setAttribute('data-theme-initialized', 'true')
          
        } catch (e) {
          // Fallback per sicurezza - rimuovi comunque la classe loading
          document.documentElement.classList.remove('theme-loading')
          console.warn('Theme initialization failed:', e)
        }
      })()
    </script>

    <!-- favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" href="/images/logo_stefano_chermaz_sm.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/images/logo_stefano_chermaz_sm.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/images/logo_stefano_chermaz_sm.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#1f63ff" />

    {useLocalizedMeta ? (
      <LocalizedMeta title={title} description={description} pageKey={pageKey} ogImage={image} />
    ) : (
      <SiteMeta title={title} description={(description||'').substring(0, 150)} url={url} image={image} author={author} />
    )}

    <slot name="head" />
    
    <!-- hreflang alternates gestiti da LocalizedMeta/SiteMeta -->

    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
    
    <!-- Analytics sarà caricato condizionalmente dal sistema di consenso cookie -->
    
    <!-- Temporary disable view transitions for debugging -->
    <!-- {enableTransitions && <ClientRouter />} -->
  </head>
  
  <body>
    <a href="#main-content" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-50 focus:rounded-md focus:bg-brand-600 focus:px-3 focus:py-2 focus:text-white">Salta al contenuto</a>
    
    <Header />
    <div class="container">
      <Breadcrumbs currentLabel={title} />
    </div>
    <main id="main-content">
      <slot />
    </main>
    <Footer />
    <CookieBanner />
    
    <!-- SEO Debug (solo in dev - attivabile con Ctrl+Shift+S) -->
    <SEODebug enable={import.meta.env.DEV} />
    
    <style lang="scss" is:global>
      html, body { min-height: 100vh; }
      body { display: flex; flex-direction: column; main { flex: 1; } }
      #main-navigation { position: relative; z-index: 50; }
      
      /* Previeni FOUC durante il caricamento del tema con una transizione fluida */
      .theme-loading * {
        transition: none !important;
      }
      
      html[data-theme-initialized] * {
        transition: color 0.15s ease, background-color 0.15s ease, border-color 0.15s ease !important;
      }
      
      /* Fix per dark mode - applica gli stili dark quando html ha classe darkmode */
      .darkmode {
        /* Forza Tailwind a riconoscere le varianti dark: */
        .dark\:bg-zinc-900, [class*="dark:bg-zinc-900"] { background-color: rgb(24 24 27) !important; }
        .dark\:bg-zinc-800, [class*="dark:bg-zinc-800"] { background-color: rgb(39 39 42) !important; }
        .dark\:text-zinc-50, [class*="dark:text-zinc-50"] { color: rgb(250 250 250) !important; }
        .dark\:text-zinc-100, [class*="dark:text-zinc-100"] { color: rgb(244 244 245) !important; }
        .dark\:text-zinc-300, [class*="dark:text-zinc-300"] { color: rgb(212 212 216) !important; }
        .dark\:text-zinc-400, [class*="dark:text-zinc-400"] { color: rgb(161 161 170) !important; }
        .dark\:ring-white\/10, [class*="dark:ring-white/10"] { --tw-ring-color: rgb(255 255 255 / 0.1) !important; }
        .dark\:bg-zinc-900\/50, [class*="dark:bg-zinc-900/50"] { background-color: rgb(24 24 27 / 0.5) !important; }
        .dark\:ring-zinc-800, [class*="dark:ring-zinc-800"] { --tw-ring-color: rgb(39 39 42) !important; }
        .dark\:ring-zinc-700, [class*="dark:ring-zinc-700"] { --tw-ring-color: rgb(63 63 70) !important; }
        
        /* Gradient backgrounds */
        .dark\:from-zinc-900, [class*="dark:from-zinc-900"] { --tw-gradient-from: rgb(24 24 27) var(--tw-gradient-from-position) !important; }
        .dark\:via-zinc-900, [class*="dark:via-zinc-900"] { --tw-gradient-to: rgb(24 24 27) var(--tw-gradient-to-position) !important; --tw-gradient-stops: var(--tw-gradient-from), rgb(24 24 27) var(--tw-gradient-via-position), var(--tw-gradient-to) !important; }
        .dark\:to-zinc-800, [class*="dark:to-zinc-800"] { --tw-gradient-to: rgb(39 39 42) var(--tw-gradient-to-position) !important; }
        
        /* Badge e icon colors */
        .dark\:bg-blue-900\/30, [class*="dark:bg-blue-900/30"] { background-color: rgb(30 58 138 / 0.3) !important; }
        .dark\:bg-green-900\/30, [class*="dark:bg-green-900/30"] { background-color: rgb(20 83 45 / 0.3) !important; }
        
        /* Text colors aggiuntivi */
        .dark\:text-gray-400, [class*="dark:text-gray-400"] { color: rgb(156 163 175) !important; }
        .dark\:text-green-400, [class*="dark:text-green-400"] { color: rgb(74 222 128) !important; }
        .dark\:text-brand-400, [class*="dark:text-brand-400"] { color: rgb(139 180 255) !important; }
        
        /* Background colors aggiuntivi */
        .dark\:bg-gray-800, [class*="dark:bg-gray-800"] { background-color: rgb(31 41 55) !important; }
        .dark\:hover\:bg-zinc-800, [class*="dark:hover:bg-zinc-800"]:hover { background-color: rgb(39 39 42) !important; }
        
        /* Ring colors */
        .dark\:ring-zinc-700, [class*="dark:ring-zinc-700"] { --tw-ring-color: rgb(63 63 70) !important; }
        .dark\:bg-purple-900\/30 { background-color: rgb(88 28 135 / 0.3) !important; }
        .dark\:bg-orange-900\/30 { background-color: rgb(154 52 18 / 0.3) !important; }
        .dark\:bg-amber-900\/30 { background-color: rgb(120 53 15 / 0.3) !important; }
        .dark\:bg-brand-900\/30 { background-color: rgb(9 29 82 / 0.3) !important; }
        
        .dark\:text-blue-400 { color: rgb(96 165 250) !important; }
        .dark\:text-green-400 { color: rgb(74 222 128) !important; }
        .dark\:text-green-300 { color: rgb(134 239 172) !important; }
        .dark\:text-purple-400 { color: rgb(196 181 253) !important; }
        .dark\:text-orange-400 { color: rgb(251 146 60) !important; }
        .dark\:text-amber-300 { color: rgb(252 211 77) !important; }
        .dark\:text-brand-400 { color: rgb(139 180 255) !important; }
        .dark\:text-brand-300 { color: rgb(141 180 255) !important; }
        
        /* Hover effects */
        .group:hover .dark\:group-hover\:border-brand-800 { border-color: rgb(13 43 122) !important; }
        .group:hover .dark\:group-hover\:text-brand-400 { color: rgb(139 180 255) !important; }
      }
      
      /* Fix per light mode - forza i colori light quando NON in darkmode */
      html:not(.darkmode):not(.dark) {
        .dark\:bg-zinc-900, [class*="dark:bg-zinc-900"] { background-color: rgb(255 255 255) !important; }
        .dark\:bg-zinc-800, [class*="dark:bg-zinc-800"] { background-color: rgb(248 250 252) !important; }
        .dark\:text-zinc-50, [class*="dark:text-zinc-50"] { color: rgb(24 24 27) !important; }
        .dark\:text-zinc-100, [class*="dark:text-zinc-100"] { color: rgb(39 39 42) !important; }
        .dark\:text-zinc-300, [class*="dark:text-zinc-300"] { color: rgb(113 113 122) !important; }
        .dark\:text-zinc-400, [class*="dark:text-zinc-400"] { color: rgb(161 161 170) !important; }
        .dark\:ring-zinc-800, [class*="dark:ring-zinc-800"] { --tw-ring-color: rgb(228 228 231) !important; }
        .dark\:ring-zinc-700, [class*="dark:ring-zinc-700"] { --tw-ring-color: rgb(212 212 216) !important; }
        
        /* Mobile-specific overrides */
        @media (max-width: 768px) {
          .bg-white { background-color: rgb(255 255 255) !important; }
          .bg-zinc-100 { background-color: rgb(244 244 245) !important; }
          .text-zinc-900 { color: rgb(24 24 27) !important; }
          .text-zinc-700 { color: rgb(63 63 70) !important; }
          .text-zinc-600 { color: rgb(82 82 91) !important; }
          .ring-zinc-200 { --tw-ring-color: rgb(228 228 231) !important; }
          .border-zinc-200 { border-color: rgb(228 228 231) !important; }
        }
      }
    </style>
  </body>
</html>