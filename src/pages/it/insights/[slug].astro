---
import PostLayout from '../../../layouts/PostLayout.astro'
import { getCollection, getEntry, render } from 'astro:content'
import { getRelatedPostsSimple, getFallbackPosts } from '../../../utils/relatedPosts'

export const prerender = true;

const { slug } = Astro.params
// I file italiani sono ora nella root
const entry = await getEntry('insights', slug)
if (!entry) throw new Error('Not found')
const { Content } = await render(entry)

// Carica tutti i post per calcolare i correlati
const allPosts = await getCollection('insights', ({ id }) => {
  const normalizedId = id.replace(/\\/g, '/')
  // Solo post italiani (senza prefisso)
  return !normalizedId.startsWith('en-') && !normalizedId.startsWith('sl-')
})

// Calcola articoli correlati
let relatedPosts = getRelatedPostsSimple(entry, allPosts, 3)

// Se non trova abbastanza correlati, usa il fallback
if (relatedPosts.length < 2) {
  const fallbackPosts = getFallbackPosts(entry, allPosts, 3)
  // Combina correlati + fallback senza duplicati
  const existingIds = new Set(relatedPosts.map(p => p.id))
  const additionalPosts = fallbackPosts.filter(p => !existingIds.has(p.id))
  relatedPosts = [...relatedPosts, ...additionalPosts].slice(0, 3)
}

export async function getStaticPaths() {
  const collection = await getCollection('insights', ({ id }) => {
    const normalizedId = id.replace(/\\/g, '/')
    // I file italiani sono ora nella root (senza prefisso di lingua)
    return !normalizedId.includes('/')
  })
  return collection
    .filter((e) => (e.data?.status ?? 'publish') === 'publish')
    .map((e) => {
      const full = e.slug ?? e.id.replace(/\.mdx?$/, '')
      // Rimuovi il prefisso it/ se presente, altrimenti usa il nome completo
      const local = full.replace(/^it\//, '')
      return { params: { slug: local } }
    })
}
---
<PostLayout frontmatter={entry.data} slug={slug} relatedPosts={relatedPosts}>
  <Content />
</PostLayout>


