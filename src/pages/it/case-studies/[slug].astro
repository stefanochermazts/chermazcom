---
import UnifiedLayout from '../../../layouts/UnifiedLayout.astro'
import BreakoutImage from '../../../components/BreakoutImage.astro'
import { getCollection, getEntry, render } from 'astro:content'

export const prerender = true;

export async function getStaticPaths() {
  const collection = (await getCollection('caseStudies')).filter(e=> !e.id.startsWith('en-'))
  return collection.map((e) => {
    const full = e.slug ?? e.id.replace(/\.mdx?$/, '')
    return { params: { slug: full } }
  })
}

const { slug } = Astro.params
const entry = await getEntry('caseStudies', slug)
if (!entry) throw new Error('Not found')
const { Content } = await render(entry)

// Get the hero image - prefer cover.webp over card.webp for hero display
function getHeroImage(data: any, slug: string) {
  // Try cover format first for hero display
  const coverPath = `/case-studies/${slug}/cover.webp`
  
  // Then try from frontmatter
  const fmCandidates = [data.image, data.ogImage, data.featuredImage]
  for (const candidate of fmCandidates) {
    if (typeof candidate === 'string' && candidate.trim().length > 0) {
      // Prefer cover format if it follows the pattern
      if (candidate.includes('/case-studies/')) {
        const basePath = candidate.substring(0, candidate.lastIndexOf('/'))
        return `${basePath}/cover.webp`
      }
      return candidate.trim()
    }
  }
  
  // Fallback to cover path (script should have generated it)
  return coverPath
}

const heroImage = getHeroImage(entry.data, slug)
---
<UnifiedLayout enableTransitions={true} title={entry.data.title}>
  <article class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 my-10 prose prose-lg dark:prose-invert">
    <header class="not-prose mb-6">
      <h1 class="mt-2 text-3xl sm:text-4xl lg:text-5xl font-extrabold tracking-tight text-zinc-900 dark:text-zinc-50">{entry.data.title}</h1>
      {entry.data.kpi && <p class="mt-2 text-lg text-zinc-700 dark:text-zinc-300"><strong>{entry.data.kpi}</strong></p>}
    </header>

    <BreakoutImage src={heroImage} alt={entry.data.title} />

    <div class="content-large prose-headings:scroll-mt-24">
      <Content />
    </div>
  </article>
</UnifiedLayout>


